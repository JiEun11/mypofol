## 11. Aggregation Framework


#### 01. pipeline operations

01.  pipeline

    ```    
    
    (input documents)  ->  |operation1|  ->  |operation2|  ->  |operation3|  ->  (output documents) 

    ```


02.  aggreagate commands
    1)  aggregate
    2)  count
    3)  distinct
    4)  mapReduce

03.  aggregation pipeline (using aggregate command)

    ```

    db.collection.aggregate([   {<stage>},   {<stage>},   {<stage>}   ])

                                {<stage>} -> {<stage>} -> {<stage>}

    ```

    -   최초 input이 되는 document들은 collection 이다.
    -   aggregate 명령어의 파라미터인 배열로 pipeline을 구성한다.
    -   그 배열 안에 operation을 {<stage>} 형식으로 정의한다.
    -   특정 $operator를 사용하여 다양한 stage를 처리하고자 하는 목적에 맞는 operation으로 정의한다.
        
        ```
        db.collection.aggregate([ {$match: …}, {$group: …}, {$match: …}, {$sort: …} ])
        
        ``

#### 02. stage operators

01.  $project
    
    1)  pipeline operators

        -   arithmetic
            
            $add, $subtract, $multiply, $pow, $round, $sqrt, ...

        -   array
            
            $size, $map, $reduce, $filter, $arrayElemAt, ...

        -   dqdqw
  
    2)  examples: [ex02-01]
        
            1.  숙박 시설의 리뷰(reviews) 갯수 구하기

            2.  숙박 시설의 guest 가능 인원(guests_included)을 뺀 수용 인원(accommodates) 구하기

    3)  practice: [practice02-01]

02.   $match

    1)  examples: [ex02-02]

        캐나다('Canada')에 있는 숙박 시설들의 리뷰(reviews) 갯수를 출력하되,
        갯수와 함께 나라 이름도 출력(단, 필드 이름을 'country'로 바꿔서 출력)

    2)  practice [practice02-02]

3.   $sort
    
    1)  examples: [ex02-03]

        ex02-02 결과를 리뷰 갯수가 제일 많은 순으로 출력

    2)  practice: [practice02-03]

4.  $group
    
    1)  accumulator operator

        $count, $max, $min, $avg, $sum, ...

    2)  examples: [ex02-04]

        1.  전체 무비의 갯수

        2.  러닝타임이 제일 긴 무비

        3.  년도별 발표된 무비의 갯수

    3)  practice: [practice02-04]


5.  $unwind
    
    1)  document 내의 embed 된 배열 안의 doucment들과 조인(join)된 문서들을 출력한다.

    2)  examples: [ex02-05]

        1.  education과 join된 portfolios document 배열 확인하기

        2.  $group 스테이징에서 name별로 education 갯수 세기

    3)  practice: [practice02-05]


6.  $limit
7.  $skip
8.  $geoNear
9.  $out
10. $redact





     